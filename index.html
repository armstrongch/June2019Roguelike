<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>June 2019 Roguelike</title>
		<style>
			canvas {
				border: 1px solid black;
				display: inline;
			}
			.infoBarTD {
				border: 1px solid black;
				padding: 5px;
				text-align: center;
				max-width: 30%;
			}
		</style>
	</head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<body onload="setupRoom(720, 720)">
		<table>
			<tr>
				<td valign="top" class="infoBarTD">
					<h3>
						Health:<br/>
						<span id="playerHealthSpan"></span> / 20<br/>
					</h3>
					<h3>
						Weapon:<br/>
						<span id="playerWeaponSpan"></span><br/>
						<i><span id="playerWeaponDesc"></span></i><br/>
					</h3>
					<h3>
						Armor:<br/>
						<span id="playerArmorSpan"></span><br/>
						<i><span id="playerArmorDesc"></span></i><br/>
					</h3>
					<h3>
						Rings:<br/>
						<span id="playerRingSpan"></span><br/>
					</h3>
				</td>
				<td>
					<canvas id="gameCanvas" width="0" height="0"></canvas>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<h4 id="colorCommentary"></h4>
				</td>
			</tr>
		</table>
	</body>
	<script>
		var gameCanvas = $("#gameCanvas")[0];
		var ctx = gameCanvas.getContext("2d");
		$("#gameCanvas").mouseup(function(e){handleMouseUp(e);});
		$(document).keydown(function(e){handleKeyUp(e)});
		var spaceSize = 48;
		var playerTurn = false;
		var player;
		var monsterWaveNumber = 0;
		var numberOfMonsters = 0;
		//Emoji Source
		//https://unicode.org/emoji/charts/full-emoji-list.html
		
		var monsterDesc =
		{
			"Goblin": "a run-of-the-mill spooker"
		};
		
		function createLoot(monsterName)
		{
			var lootIndex = Math.floor(Math.random()*lootList.length);
			var lootName = lootList[lootIndex][0];
			var type = lootList[lootIndex][1];

			var message = monsterName 
				+ " dropped some loot: " + lootName + ".";
			showMessage(message);
			switch(type)
			{
				case "weapon":
					message = "Replace " + player.weapon 
						+ " with " + lootName + " (" + weaponDesc[lootName] + ")?";
					if (confirm(message))
					{
						player.weapon = lootName;
					}
					break;
				case "armor":
					message = "Replace " + player.armor 
						+ " with " + lootName + " (" + armorDesc[lootName] + ")?";
					if (confirm(message))
					{
						player.armor = lootName;
					}
					break;
				case "ring":
					message = "Put on " + lootName + " (" + ringDesc[lootName] + ")?";
					if (confirm(message))
					{
						player.rings += 
						{
							name: lootName,
							charges: 5
						};
					}
					break;
			}
		}
		
		var weaponDesc =
		{
			"Cattle Prod": "standard melee weapon",
			"Twin Sword": "killing a monster kills all other monsters of the same species"
		};
		
		var armorDesc =
		{
			"Denim Overalls": "standard armor",
			"Leather Armor": "reduces incoming damage by 1"
		};
		
		var ringDesc =
		{
			"Goblin-Squashing Ring": "reduces damage from goblins to zero"
		};
		
		var lootList = [];
		lootList[0] = ["Twin Sword", "weapon"];
		lootList[1] = ["Leather Armor", "armor"];
		lootList[2] = ["Goblin-Squashing Ring", "ring"];
		
		function roomObject (xPos, yPos, name, stopsPlayerMovement)
		{
			this.xPos = xPos;
			this.yPos = yPos;
			this.name = name;
			this.stopsPlayerMovement = stopsPlayerMovement;
			this.isMonster = false;
			this.monsterLevel = 0;
		}
		var roomObjects =[];
		
		function checkPlayerMovement(obj)
		{
			if (obj.stopsPlayerMovement)
			{
				if (obj.xPos == player.xPos)
				{
					if (obj.yPos == player.yPos + spaceSize)
					{
						player.canMoveDown = false;
					}
					else if (obj.yPos == player.yPos - spaceSize)
					{
						player.canMoveUp = false;
					}
				}
				else if (obj.yPos == player.yPos)
				{
					if (obj.xPos == player.xPos + spaceSize)
					{
						player.canMoveRight = false;
					}
					else if (obj.xPos == player.xPos - spaceSize)
					{
						player.canMoveLeft = false;
					}
				}
			}
		}
		
		function setupRoom(roomWidth, roomHeight)
		{
			gameCanvas.width = roomWidth;
			gameCanvas.height = roomHeight;
			
			var playerXPos = 0;
			var playerYPos = 0;
			
			playerXPos = 7*spaceSize;
			playerYPos = 7*spaceSize;
			for (i = 0; i < gameCanvas.width; i += spaceSize)
			{
				roomObjects.push(new roomObject(i, 0, "tree", true));
				roomObjects.push(new roomObject(i, gameCanvas.height-spaceSize, "tree", true));
			}
			for (i = spaceSize; i < gameCanvas.height - spaceSize; i += spaceSize)
			{
				roomObjects.push(new roomObject(0, i, "tree", true));
				roomObjects.push(new roomObject(gameCanvas.width-spaceSize, i, "tree", true));
			}
			for (i = spaceSize; i < gameCanvas.width - spaceSize; i += spaceSize)
			{
				roomObjects.push(new roomObject(i, spaceSize, "grass", false));
				roomObjects.push(new roomObject(i, gameCanvas.height-(spaceSize*2), "grass", false));
			}
			for (i = (spaceSize*2); i < gameCanvas.height - (spaceSize*2); i += spaceSize)
			{
				roomObjects.push(new roomObject(spaceSize, i, "grass", false));
				roomObjects.push(new roomObject(gameCanvas.width-(spaceSize*2), i, "grass", false));
			}
			
			player = {
				xPos: playerXPos,
				yPos: playerYPos,
				canMoveUp: true,
				canMoveDown: true,
				canMoveLeft: true,
				canMoveRight: true,
				health: 20,
				weapon: "Cattle Prod",
				armor: "Denim Overalls",
				rings: [],
				dead: false
			};
			
			drawCanvas();
		}
		
		function handleKeyUp(e)
		{
			if (playerTurn)
			{
				var k = e.keyCode;
				switch (k) {
					case 38: //up
						clickUp();
						break;
					case 40: //down
						clickDown();
						break;	
					case 37: //left
						clickLeft();
						break;	
					case 39: //right
						clickRight();
						break;
				}
			}
		}
		
		function handleMouseUp(e)
		{
			if (playerTurn)
			{
				var canvasOffset = $("#gameCanvas").offset();
				var offsetX = canvasOffset.left;
				var offsetY = canvasOffset.top;
				var spaceXPos = Math.floor(parseInt(e.clientX-offsetX)/spaceSize)*spaceSize;
				var spaceYPos = Math.floor(parseInt(e.clientY-offsetY)/spaceSize)*spaceSize;
				if ((spaceXPos == player.xPos) && (spaceYPos == player.yPos + spaceSize))
				{
					clickDown();
				}
				else if ((spaceXPos == player.xPos) && (spaceYPos == player.yPos - spaceSize))
				{
					clickUp();
				}
				else if ((spaceXPos == player.xPos + spaceSize) && (spaceYPos == player.yPos))
				{
					clickRight();
				}
				else if ((spaceXPos == player.xPos - spaceSize) && (spaceYPos == player.yPos))
				{
					clickLeft();
				}
			}
		}
		
		function clickUp()
		{
			if (player.canMoveUp)
			{
				player.yPos -= spaceSize;
				var playerTurn = false;
				enemyTurn();
			}
		}
		
		function clickDown()
		{
			if (player.canMoveDown)
			{
				player.yPos += spaceSize;
				var playerTurn = false;
				enemyTurn();
			}
		}
		
		function clickLeft()
		{
			if (player.canMoveLeft)
			{
				player.xPos -= spaceSize;
				var playerTurn = false;
				enemyTurn();
			}
		}
		
		function clickRight()
		{
			if (player.canMoveRight)
			{
				player.xPos += spaceSize;
				var playerTurn = false;
				enemyTurn();
			}
		}
		
		function pointDistance(x1, y1, x2, y2)
		{
			return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
		}
		
		function drawCanvas()
		{
			ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
			drawBackground();
			drawRoomObjects();
			drawPlayer();
			drawSidebarInfo();
		}
		
		function drawSidebarInfo()
		{
			$('#playerHealthSpan').html(player.health);
			$('#playerWeaponSpan').html(player.weapon);
			$('#playerWeaponDesc').html(weaponDesc[player.weapon]);
			$('#playerArmorSpan').html(player.armor);
			$('#playerArmorDesc').html(armorDesc[player.armor]);
			var ringHtml = "Rings:</br>";
			for (i = 0; i < player.rings.length; i++)
			{
				var ring = player.rings[i];
				ringHtml += ring.name +"(" + ring.charges + "): <i>" + ringDesc[ring] + "</i><br/>";
			}
		}
		
		function drawBackground()
		{
			for (i = 0; i < gameCanvas.width; i += spaceSize)
			{
				ctx.moveTo(0, i);
				ctx.lineTo(gameCanvas.width, i);
				ctx.stroke();
			}
			for (i = 0; i < gameCanvas.height; i += spaceSize)
			{
				ctx.moveTo(i, 0);
				ctx.lineTo(i, gameCanvas.width);
				ctx.stroke();
			} 
		}
		
		function drawPlayer()
		{
			ctx.font = spaceSize*0.7+"px Arial";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			
			ctx.fillText(String.fromCodePoint(0x1F920), 
				player.xPos + spaceSize/2, 
				player.yPos + spaceSize/2);
			
			playerTurn = true;
		}
		
		function drawRoomObjects()
		{
			player.canMoveUp = true;
			player.canMoveDown = true;
			player.canMoveLeft = true;
			player.canMoveRight = true;
			
			ctx.font = spaceSize*0.7+"px Arial";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			
			for (i = roomObjects.length - 1; i >= 0; i--)
			{
				var obj = roomObjects[i];
				var objCode;

				switch (obj.name) {
				case "tree":
					objCode = String.fromCodePoint(0x1F333);
					break;
				case "grass":
					objCode = String.fromCodePoint(0x1F33F);
					break;
				case "Goblin":
					objCode = String.fromCodePoint(0x1F47A);
					break;
				}
				
				ctx.fillText(objCode, 
				obj.xPos + spaceSize/2, 
				obj.yPos + spaceSize/2);
				checkPlayerMovement(obj);
			}
		}
		
		function enemyTurn()
		{
			for (i = roomObjects.length - 1; i >= 0; i--)
			{
				var obj = roomObjects[i];
				if ((obj.isMonster) && (!obj.dead))
				{
					if ((player.xPos == obj.xPos) && (player.yPos == obj.yPos))
					{
						fightMonster(obj, i);
					}
					else if ((obj.xPos == player.xPos)|| (Math.random() > 0.5))
					{
						obj.yPos += (obj.yPos > player.yPos) ? -spaceSize : spaceSize;
					}
					else
					{
						obj.xPos += (obj.xPos > player.xPos) ? -spaceSize : spaceSize;
					}
					//Check collision before moving AND after moving
					if ((player.xPos == obj.xPos) && (player.yPos == obj.yPos) && (!obj.dead))
					{
						fightMonster(obj, i);
					}
				}
			}
			if (numberOfMonsters == 0)
			{
				generateMonsters();
			}
			drawCanvas();
		}
		
		function fightMonster(obj, index)
		{
			player.health -= obj.monsterLevel;
			showMessage(obj.name + " deals " + obj.monsterLevel + " damage.");
			obj.dead = true;
			showMessage(obj.name + " is defeated.");
			roomObjects.splice(index, 1);
			if (player.health > 0)
			{
				createLoot(obj.name);
			}
			else
			{
				alert("Game Over");
				location.reload();
			}
		}
		
		function generateMonsters()
		{
			monsterWaveNumber++;
			var monstersToGenerate = monsterWaveNumber;
			while (monstersToGenerate > 0)
			{
				monsterLevel = Math.ceil(monstersToGenerate*Math.random());
				generateMonster(monsterLevel);
				monstersToGenerate -= monsterLevel;
				numberOfMonsters++;
			}
		}
		
		function generateMonster(monsterLevel)
		{
			var monster = new roomObject(0, 0, "none", false);
			var roomSide = Math.floor(4*Math.random());
			switch(roomSide)
			{
				case 0:
					monster.yPos = spaceSize;
					monster.xPos = spaceSize + Math.floor((Math.random() * (gameCanvas.width - (spaceSize*2))) / spaceSize) * spaceSize;
					break;
				case 1:
					monster.yPos = gameCanvas.height - spaceSize*2;
					monster.xPos = spaceSize + Math.floor((Math.random() * (gameCanvas.width - spaceSize*2)) / spaceSize) * spaceSize;
					break;
				case 2:
					monster.xPos = spaceSize;
					monster.yPos = spaceSize + Math.floor((Math.random() * (gameCanvas.height - (spaceSize*2))) / spaceSize) * spaceSize;
					break;
				case 3:
					monster.xPos = gameCanvas.height - spaceSize*2;;
					monster.yPos = spaceSize + Math.floor((Math.random() * (gameCanvas.height - (spaceSize*2))) / spaceSize) * spaceSize;
					break;
			}
			switch (monsterLevel) {
				case 1:
					monster.name = "Goblin";
					monster.monsterLevel = monsterLevel;
					break;
			}
			monster.isMonster = true;
			roomObjects.push(monster);
			showMessage("A <button onClick=\"monsterInfo('" + monster.name + "', '" + monster.monsterLevel + "')\"><strong>" + monster.name + "</strong></button> emerges in the tall grass!");
		}
		
		function monsterInfo(monsterName, monsterLevel)
		{
			var text = "Level " + monsterLevel + ", " + monsterDesc[monsterName];
			alert(text);
		}
		
		function showMessage(text)
		{
			$('#colorCommentary').html(
				text
				+ "<br/>"
				+ $('#colorCommentary').html()
			);
		}
	</script>
</html>
